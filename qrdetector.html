<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QR Code Scanner</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsqr/1.4.0/jsQR.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .scanner-container {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        text-align: center;
        max-width: 500px;
        width: 100%;
      }

      h1 {
        color: #333;
        margin-bottom: 20px;
        font-size: 2em;
        background: linear-gradient(45deg, #667eea, #764ba2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .camera-container {
        position: relative;
        display: inline-block;
        border-radius: 15px;
        overflow: hidden;
        margin: 20px 0;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      #video {
        width: 100%;
        max-width: 400px;
        height: auto;
        display: block;
      }

      .scanning-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        pointer-events: none;
      }

      .scan-frame {
        width: 200px;
        height: 200px;
        border: 3px solid #00ff88;
        border-radius: 15px;
        position: relative;
        background: rgba(0, 255, 136, 0.1);
        animation: pulse 2s infinite;
      }

      .scan-frame::before,
      .scan-frame::after {
        content: "";
        position: absolute;
        width: 20px;
        height: 20px;
        border: 3px solid #00ff88;
      }

      .scan-frame::before {
        top: -3px;
        left: -3px;
        border-right: none;
        border-bottom: none;
        border-radius: 15px 0 0 0;
      }

      .scan-frame::after {
        bottom: -3px;
        right: -3px;
        border-left: none;
        border-top: none;
        border-radius: 0 0 15px 0;
      }

      @keyframes pulse {
        0%,
        100% {
          box-shadow: 0 0 0 0 rgba(0, 255, 136, 0.7);
        }
        50% {
          box-shadow: 0 0 0 10px rgba(0, 255, 136, 0);
        }
      }

      .scan-line {
        position: absolute;
        width: 100%;
        height: 2px;
        background: linear-gradient(90deg, transparent, #00ff88, transparent);
        top: 50%;
        animation: scan 2s linear infinite;
      }

      @keyframes scan {
        0% {
          transform: translateY(-100px);
          opacity: 0;
        }
        50% {
          opacity: 1;
        }
        100% {
          transform: translateY(100px);
          opacity: 0;
        }
      }

      .result {
        margin-top: 20px;
        padding: 15px;
        border-radius: 10px;
        min-height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
      }

      .result.success {
        background: linear-gradient(45deg, #4caf50, #45a049);
        color: white;
        animation: successPulse 0.5s ease;
      }

      .result.waiting {
        background: #f8f9fa;
        color: #666;
        border: 2px dashed #ddd;
      }

      .result.error {
        background: linear-gradient(45deg, #f44336, #d32f2f);
        color: white;
      }

      @keyframes successPulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
        100% {
          transform: scale(1);
        }
      }

      .controls {
        margin-top: 20px;
        display: flex;
        gap: 10px;
        justify-content: center;
        flex-wrap: wrap;
      }

      button {
        padding: 12px 24px;
        border: none;
        border-radius: 25px;
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      }

      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      }

      button:active {
        transform: translateY(0);
      }

      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .status {
        margin-top: 15px;
        padding: 10px;
        border-radius: 8px;
        font-size: 14px;
        background: rgba(102, 126, 234, 0.1);
        color: #555;
      }

      #canvas {
        display: none;
      }

      .copy-btn {
        background: linear-gradient(45deg, #28a745, #20c997);
        margin-top: 10px;
        font-size: 14px;
        padding: 8px 16px;
      }

      .history-item {
        text-align: left;
        margin: 10px 0;
        padding: 10px;
        background: rgba(102, 126, 234, 0.1);
        border-radius: 8px;
        font-size: 14px;
      }

      @media (max-width: 600px) {
        .scanner-container {
          margin: 10px;
          padding: 20px;
        }

        h1 {
          font-size: 1.5em;
        }

        .scan-frame {
          width: 150px;
          height: 150px;
        }
      }
    </style>
  </head>
  <body>
    <div class="scanner-container">
      <h1>üîç QR Scanner</h1>

      <div class="camera-container">
        <video id="video" autoplay muted playsinline></video>
        <div class="scanning-overlay">
          <div class="scan-frame">
            <div class="scan-line"></div>
          </div>
        </div>
      </div>

      <canvas id="canvas"></canvas>

      <div id="result" class="result waiting">
        Position a QR code within the frame to scan
      </div>

      <div class="controls">
        <button id="startBtn">Start Camera</button>
        <button id="stopBtn" disabled>Stop Camera</button>
        <button id="debugBtn">Debug Mode</button>
        <button id="historyBtn">Show History</button>
      </div>

      <div id="status" class="status">
        Click "Start Camera" to begin scanning
      </div>
    </div>

    <script>
      const video = document.getElementById("video");
      const canvas = document.getElementById("canvas");
      const context = canvas.getContext("2d");
      const result = document.getElementById("result");
      const status = document.getElementById("status");
      const startBtn = document.getElementById("startBtn");
      const stopBtn = document.getElementById("stopBtn");
      const debugBtn = document.getElementById("debugBtn");
      const historyBtn = document.getElementById("historyBtn");

      let stream = null;
      let scanning = false;
      let lastScanTime = 0;
      const scanCooldown = 1000; // 1 second cooldown between scans
      let scanHistory = [];
      let onQRCodeScanned = null; // Callback function
      let lastScannedValue = null; // Store the last scanned value

      // QR Scanner API
      const QRScanner = {
        // Set a callback function to be called when QR code is scanned
        onScan: function (callback) {
          onQRCodeScanned = callback;
        },

        // Get the last scanned QR code value
        getLastScannedValue: function () {
          return lastScannedValue;
        },

        // Get scan history
        getHistory: function () {
          return [...scanHistory];
        },

        // Clear history
        clearHistory: function () {
          scanHistory = [];
        },

        // Start scanning programmatically
        start: startCamera,

        // Stop scanning programmatically
        stop: stopCamera,

        // Check if currently scanning
        isScanning: function () {
          return scanning;
        },
      };

      // Make QRScanner available globally
      window.QRScanner = QRScanner;

      async function startCamera() {
        try {
          status.textContent = "Requesting camera access...";

          // Try multiple camera configurations
          let cameraConfig = {
            video: {
              facingMode: "environment",
              width: { ideal: 640 },
              height: { ideal: 480 },
            },
          };

          try {
            stream = await navigator.mediaDevices.getUserMedia(cameraConfig);
          } catch (envError) {
            console.log(
              "Environment camera failed, trying user camera:",
              envError
            );
            // Fallback to front camera
            cameraConfig.video.facingMode = "user";
            try {
              stream = await navigator.mediaDevices.getUserMedia(cameraConfig);
            } catch (userError) {
              console.log("User camera failed, trying any camera:", userError);
              // Fallback to any available camera
              stream = await navigator.mediaDevices.getUserMedia({
                video: true,
              });
            }
          }

          video.srcObject = stream;

          video.onloadedmetadata = () => {
            console.log(
              "Video loaded:",
              video.videoWidth,
              "x",
              video.videoHeight
            );
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            scanning = true;
            scanQRCode();

            startBtn.disabled = true;
            stopBtn.disabled = false;
            status.textContent = `Camera active (${video.videoWidth}x${video.videoHeight}) - Position QR code in the frame`;
            result.className = "result waiting";
            result.textContent =
              "Scanning for QR codes... Make sure QR code is well-lit and clear";
          };

          video.onerror = (e) => {
            console.error("Video error:", e);
            status.textContent = "Video stream error";
          };
        } catch (err) {
          console.error("Camera error:", err);
          status.textContent = `Camera error: ${err.message}`;
          result.className = "result error";
          result.textContent = `Unable to access camera: ${err.name}. Please check permissions and try refreshing.`;
        }
      }

      function stopCamera() {
        scanning = false;
        if (stream) {
          stream.getTracks().forEach((track) => track.stop());
          stream = null;
        }

        video.srcObject = null;
        startBtn.disabled = false;
        stopBtn.disabled = true;
        status.textContent = "Camera stopped";
        result.className = "result waiting";
        result.textContent = 'Click "Start Camera" to begin scanning';
      }

      let scanAttempts = 0;
      let debugMode = false;

      function scanQRCode() {
        if (!scanning || video.videoWidth === 0 || video.videoHeight === 0) {
          if (scanning) {
            requestAnimationFrame(scanQRCode);
          }
          return;
        }

        scanAttempts++;

        // Draw video frame to canvas
        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        // Get image data
        const imageData = context.getImageData(
          0,
          0,
          canvas.width,
          canvas.height
        );

        // Update debug info every 30 frames
        if (scanAttempts % 30 === 0 && debugMode) {
          console.log(
            `Scan attempt ${scanAttempts}, Image data: ${imageData.width}x${imageData.height}`
          );
        }

        // Scan for QR code with more aggressive settings
        const code = jsQR(imageData.data, imageData.width, imageData.height, {
          inversionAttempts: "attemptBoth",
        });

        const currentTime = Date.now();

        if (code && currentTime - lastScanTime > scanCooldown) {
          lastScanTime = currentTime;
          handleQRCodeDetected(code.data);
        }

        // Show scanning status
        if (scanAttempts % 60 === 0) {
          // Every 60 frames (about 1 second)
          if (!code) {
            status.textContent = `Scanning... (${Math.floor(
              scanAttempts / 60
            )}s) - Ensure QR code is clear and well-lit`;
          }
        }

        // Continue scanning
        if (scanning) {
          requestAnimationFrame(scanQRCode);
        }
      }

      function handleQRCodeDetected(data) {
        // Store the last scanned value
        lastScannedValue = data;

        // Add to history
        const scanRecord = {
          data: data,
          timestamp: Date.now(),
          type:
            data.startsWith("http://") || data.startsWith("https://")
              ? "url"
              : "text",
        };
        scanHistory.push(scanRecord);

        // Display result in UI
        displayResult(data);

        // Dispatch custom event
        const event = new CustomEvent("qrCodeScanned", {
          detail: {
            data: data,
            timestamp: scanRecord.timestamp,
            type: scanRecord.type,
          },
        });
        window.dispatchEvent(event);

        // Call the callback function if set
        if (onQRCodeScanned && typeof onQRCodeScanned === "function") {
          try {
            onQRCodeScanned(data, scanRecord);
          } catch (error) {
            console.error("Error in QR scan callback:", error);
          }
        }

        alert("üîç QR Code Detected:", data);
      }

      function displayResult(data) {
        result.className = "result success";

        // Check if it's a URL
        if (data.startsWith("http://") || data.startsWith("https://")) {
          result.innerHTML = `
            <div>
              <strong>URL Found:</strong><br>
              <a href="${data}" target="_blank" style="color: white; text-decoration: underline;">${data}</a>
              <br><button class="copy-btn" onclick="copyToClipboard('${data}')">Copy URL</button>
            </div>
          `;
        } else {
          result.innerHTML = `
            <div>
              <strong>QR Code Content:</strong><br>
              <div style="word-break: break-all; margin: 10px 0;">${data}</div>
              <button class="copy-btn" onclick="copyToClipboard('${data}')">Copy Text</button>
            </div>
          `;
        }

        status.textContent = `Last scan: ${new Date().toLocaleTimeString()} - Value: ${data.substring(
          0,
          30
        )}${data.length > 30 ? "..." : ""}`;

        // Play a success sound (if supported)
        try {
          const audio = new Audio(
            "data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmYfCz2a2+/CdSYELYHO8tiJOQcZaLvt559NEAxPqOPwtmMcBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmYfCz2a2+/CdSYELYHO8tiJOQcZaLvt559NEAxPqOPwtmMcBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmYfCz2a2+/CdSYELYHO8tiJOQcZaLvt559NEAxPqOPwtmMcBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmYfCz2a2+/CdSYELYHO8tiJOQcZaLvt559NEAxPqOPwtmMcBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmYfCz2a2+/CdSYELYHO8tiJOQcZaLvt559NEAxPqOPwtmMcBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmYfCz2a2+/CdSYELYHO8tiJOQcZaLvt559NEAxPqOPwtmMcBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmYfCz2a2+/CdSYELYHO8tiJOQcZaLvt559NEAxPqOPwtmMcBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmYfCz2a2+/CdSYELYHO8tiJOQcZaLvt559NEAxPqOPwtmMcBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmYfCz2a2+/CdSYELYHO8tiJOQcZaLvt559NEAxPqOPwtmMcBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmYfCz2a2+/CdSYELYHO8tiJOQcZaLvt559NEAxPqOPwtmMcBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmYfCz2a2+/CdSYELYHO8tiJOQcZaLvt559NEAxPqOPwtmMcBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmYfCz2a2+/CdSYE"
          );
          audio.volume = 0.3;
          audio.play().catch(() => {});
        } catch (e) {}
      }

      // Copy to clipboard function
      function copyToClipboard(text) {
        navigator.clipboard
          .writeText(text)
          .then(() => {
            // Show temporary success message
            const originalText = status.textContent;
            status.textContent = "Copied to clipboard!";
            status.style.background = "rgba(76, 175, 80, 0.2)";
            setTimeout(() => {
              status.textContent = originalText;
              status.style.background = "rgba(102, 126, 234, 0.1)";
            }, 2000);
          })
          .catch((err) => {
            console.error("Failed to copy: ", err);
            // Fallback for older browsers
            const textArea = document.createElement("textarea");
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            try {
              document.execCommand("copy");
              status.textContent = "Copied to clipboard!";
            } catch (err) {
              status.textContent = "Copy failed - please copy manually";
            }
            document.body.removeChild(textArea);
          });
      }

      // Make copyToClipboard available globally
      window.copyToClipboard = copyToClipboard;

      // Event listeners
      startBtn.addEventListener("click", startCamera);
      stopBtn.addEventListener("click", stopCamera);
      debugBtn.addEventListener("click", () => {
        debugMode = !debugMode;
        debugBtn.textContent = debugMode ? "Debug: ON" : "Debug Mode";
        if (debugMode) {
          canvas.style.display = "block";
          canvas.style.position = "fixed";
          canvas.style.top = "10px";
          canvas.style.left = "10px";
          canvas.style.width = "200px";
          canvas.style.height = "150px";
          canvas.style.border = "2px solid red";
          canvas.style.zIndex = "9999";
          console.log("Debug mode enabled - Canvas visible");
        } else {
          canvas.style.display = "none";
          console.log("Debug mode disabled");
        }
      });

      historyBtn.addEventListener("click", () => {
        if (scanHistory.length === 0) {
          alert("No QR codes scanned yet");
          return;
        }

        let historyHTML = "<div style='max-height: 300px; overflow-y: auto;'>";
        historyHTML += "<h3>QR Scan History:</h3>";

        scanHistory
          .slice(-10)
          .reverse()
          .forEach((scan, index) => {
            historyHTML += `
            <div class="history-item">
              <strong>${scan.type.toUpperCase()}:</strong> ${scan.data.substring(
              0,
              50
            )}${scan.data.length > 50 ? "..." : ""}<br>
              <small>Time: ${new Date(
                scan.timestamp
              ).toLocaleString()}</small><br>
              <button onclick="copyToClipboard('${
                scan.data
              }')" style="font-size: 12px; padding: 4px 8px; margin-top: 5px;">Copy</button>
            </div>
          `;
          });
        historyHTML += "</div>";

        // Create a modal-like display
        const modal = document.createElement("div");
        modal.style.cssText = `
          position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
          background: rgba(0,0,0,0.5); display: flex; align-items: center; 
          justify-content: center; z-index: 10000;
        `;

        const content = document.createElement("div");
        content.style.cssText = `
          background: white; padding: 20px; border-radius: 10px; 
          max-width: 90%; max-height: 80%; overflow-y: auto;
        `;
        content.innerHTML =
          historyHTML +
          '<button onclick="this.closest(\'div[style*=fixed]\').remove()" style="margin-top: 10px;">Close</button>';

        modal.appendChild(content);
        document.body.appendChild(modal);
      });

      // Example usage demonstrations
      window.addEventListener("qrCodeScanned", (event) => {
        const qrData = event.detail;
        console.log("üîç QR Event Triggered:", qrData);

        // Example: Log the scanned data
        console.log("Scanned QR Code:", qrData.data);
        console.log("Scan Type:", qrData.type);
        console.log("Scan Time:", new Date(qrData.timestamp).toLocaleString());
      });

      // Example of setting a callback
      QRScanner.onScan((data, scanInfo) => {
        console.log("üì± QR Callback triggered with data:", data);
        console.log("üìä Scan info:", scanInfo);

        // You can process the QR data here
        // Example: automatically open URLs
        // if (scanInfo.type === 'url') {
        //     if (confirm('Open this URL in a new tab?\n' + data)) {
        //         window.open(data, '_blank');
        //     }
        // }
      });

      // Check if getUserMedia is supported
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        status.textContent = "Camera not supported in this browser";
        result.className = "result error";
        result.textContent = "This browser does not support camera access";
        startBtn.disabled = true;
      }

      // Auto-start camera on mobile devices
      if (/Mobi|Android/i.test(navigator.userAgent)) {
        window.addEventListener("load", () => {
          setTimeout(() => {
            if (!scanning) {
              startCamera();
            }
          }, 1000);
        });
      }

      // Console instructions for developers
      console.log(`
üîç QR Scanner API Usage:

// Set a callback for when QR codes are scanned:
QRScanner.onScan((data, scanInfo) => {
  console.log('QR Data:', data);
  console.log('Scan Info:', scanInfo);
});

// Get the last scanned value:
const lastValue = QRScanner.getLastScannedValue();

// Get scan history:
const history = QRScanner.getHistory();

// Control scanning programmatically:
QRScanner.start();  // Start camera
QRScanner.stop();   // Stop camera
QRScanner.isScanning();  // Check if scanning

// Listen for events:
window.addEventListener('qrCodeScanned', (event) => {
  console.log('QR scanned:', event.detail);
});
      `);
    </script>
  </body>
</html>
